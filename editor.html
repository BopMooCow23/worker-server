<html>
    <head>
        <script src="utils.js?bypass=1"></script>
        <script src="codemirror.min.js?bypass=1"></script>
        <script src="mime.js?bypass=1"></script>
        <link rel="stylesheet" href="codemirror.css?bypass=1">
    </head>
    <body>
        <button id="openFile">Open</button>
        <button id="new">New</button>
        <button id="save" style="display:none;">Save</button>
        <a href="/">Go to site</a>
        <div id="openFiles" style="display:none;float:left;width:10%;padding:5px;"></div>
        <div id="fileEditor" style="display:none;padding:20px;"></div>
        <div id="fileTree" style="padding:20px;">loading...</div>
        <script>
            (async function() {
                window.openFiles = [];
                window.unsaved = false;
                document.getElementById('openFile').addEventListener('click', function(e) {
                    delete window.editor;
                    delete window.currentPath;
                    document.getElementById('save').innerText = "Save";
                    window.unsaved = false;
                    document.getElementById('save').style.display = 'none';
                    document.getElementById('fileEditor').style.display = 'none';
                    document.getElementById('openFiles').style.display = 'none';
                    document.getElementById('fileTree').style.display = '';
                })
                window.chooseFile = async function(e, path) {
                    if (window.unsaved && !confirm('You have unsaved changes. Are you sure you want to leave this file?')) return;
                    var value;
                    if (path) {
                        if (!path.startsWith('/')) path='/'+path;
                        var default_types = ['text/html',
                                     'text/xml',
                                     'text/plain',
                                     "text/vnd.wap.wml",
                                     "application/javascript",
                                     "application/rss+xml"];
                        var type = window.MIMETYPES[path.split('.').pop()];
                        if (type && default_types.includes(type)) {
                            type += '; charset=utf-8';
                        }
                        file = {type: type || ''}
                        file.data = await (new Blob([''])).arrayBuffer();
                        await put(path, file);
                        var paths = await get('paths?');
                        paths.push(path);
                        await put('paths?', paths);
                        await put('fileTree?', getFileTree(paths));
                        await loadTree();
                        value = path;
                    } else if (!e&&!path) {
                        return;
                    } else {
                        e.preventDefault();
                        value = e.target.attributes.value.textContent;
                    }
                    if (!window.openFiles.includes(value)) {
                        window.openFiles.push(value);
                        var name = value.split('/').pop();
                        if (name.length > 20) {
                            name = name.substring(0, 17)+'...';
                        }
                        document.getElementById('openFiles').innerHTML += '<p><a style="text-decoration:none" href="javascript:void(0)" value="'+value+'" onclick="chooseFile(event);">'+name+'</a></p>';
                    }
                    document.getElementById('fileEditor').innerHTML = "loading...";
                    document.getElementById('fileTree').style.display = 'none';
                    document.getElementById('fileEditor').style.display = '';
                    document.getElementById('openFiles').style.display = '';
                    document.getElementById('save').style.display = '';
                    document.getElementById('save').innerText = "Save";
                    window.unsaved = false;
                    var file = await get(value);
                    window.currentPath = {path:value,type:file.type};
                    document.getElementById("fileEditor").innerHTML = "";
                    window.editor = CodeMirror(document.getElementById("fileEditor"), {
                        value: new TextDecoder('utf-8').decode(file.data),
                        lineNumbers: true,
                        tabSize: 4,
                        indentUnit: 4,
                        matchBrackets: true,
                        lineWrapping: true,
                        mode:  file.type.split(';')[0]
                    });
                    editor.setSize("90%", "90%");
                }
                document.getElementById('new').addEventListener('click', function(e) {
                    chooseFile(null, prompt('enter file path'))
                })
                async function save(e) {
                    if (!window.editor || !window.currentPath) return;
                    document.getElementById('save').innerText = "Save";
                    window.unsaved = false;
                    await put(window.currentPath.path, {
                        type: window.currentPath.type,
                        data: toArrayBuffer(window.editor.getValue())
                    })
                }
                document.getElementById('save').addEventListener('click', save);
                document.addEventListener('keydown', function(e) {
                    if (!['tab', 'meta', 'shift', 'control', 'alt', 'escape'].includes(e.key.toLowerCase()) && !e.key.toLowerCase().includes('arrow') && !e.ctrlKey) {
                        document.getElementById('save').innerText = 'Save*';
                        window.unsaved = true;
                    }
                    if (e.key === 's' && e.ctrlKey) {
                        save();
                        e.preventDefault();
                    }
                })
                async function loadTree() {
                    var tree = await get('fileTree?');
                    if (!tree) return;
                    var html = '<style>ul,#myUL{list-style-type:none}#myUL{margin:0;padding:0}.caret{cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.caret::before{content:"\\25B6";color:#000;display:inline-block;margin-right:6px}.caret-down::before{-ms-transform:rotate(90deg);-webkit-transform:rotate(90deg);transform:rotate(90deg)}.nested{display:none}.active{display:block}</style><ul id="myUL">';
                    function processFiles(a) {
                        a = a.sort(function(a, b) {
                            var anl = a.name.toLowerCase()
                            var bnl = b.name.toLowerCase()
                            if (a.isDirectory && b.isDirectory) {
                                return anl.localeCompare(bnl)
                            } else if (a.isDirectory) {
                                return -1
                            } else if (b.isDirectory) {
                                return 1
                            } else {
                                return anl.localeCompare(bnl)
                            }
                        });
                        for (var i=0; i<a.length; i++) {
                            if (a[i].isDirectory) {
                                html += '<li><span class="caret">'+a[i].name+'</span><ul class="nested">';
                                processFiles(a[i].children);
                                html += '</ul></li>';
                            } else {
                                var mime = ['html', 'css', 'txt', 'js'];
                                if (mime.includes(a[i].name.split('.').pop().toLowerCase()) || !a[i].name.includes('.')) {
                                    html += '<li><a style="text-decoration:none" href="javascript:void(0)" value="'+a[i].path+'" onclick="chooseFile(event);">'+a[i].name+'</a></li>';
                                }
                            }
                        }
                    }
                    processFiles(tree);
                    html += '</ul>';
                    document.getElementById('fileTree').innerHTML = html;
                    for(var toggler=document.getElementsByClassName("caret"),i=0;i<toggler.length;i++)toggler[i].addEventListener("click",function(){this.parentElement.querySelector(".nested").classList.toggle("active"),this.classList.toggle("caret-down")});
                }
                await loadTree();
                window.addEventListener('beforeunload', function(e) {
                    if (!window.unsaved) return;
                    e.preventDefault();
                    return e.returnValue = "You have unsaved changes. Are you sure you want to leave this file?";
                })
            })();
        </script>
    </body>
</html>
